#!/bin/bash
# Used to setup codespaces

exec > >(tee -i $HOME/dotfiles_install.log)
exec 2>&1
set -x

# Install Packages
# sudo apt-add-repository ppa:fish-shell/release-3
sudo apt-get update -y
sudo apt-get --assume-yes install ripgrep fd-find

# Install fish
debian_version=$(lsb_release -a 2>/dev/null | awk '/Release/ {print $2}')
echo "deb http://download.opensuse.org/repositories/shells:/fish/Debian_$debian_version/ /" | sudo tee /etc/apt/sources.list.d/shells:fish.list
curl -fsSL https://download.opensuse.org/repositories/shells:fish/Debian_$debian_version/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/shells_fish.gpg > /dev/null
sudo apt update
sudo apt install fish

# Install neovim
previous=$PWD
cd $HOME
curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim.appimage
chmod u+x nvim.appimage
./nvim.appimage --appimage-extract
./squashfs-root/AppRun --version
mv squashfs-root /
ln -s /squashfs-root/AppRun /usr/bin/nvim
cd $previous

rm -rf $HOME/.fzf
git clone --depth 1 https://github.com/junegunn/fzf.git $HOME/.fzf
$HOME/.fzf/install --all

## Link Dotfiles
mkdir -p $HOME/.config/nvim
mkdir -p $HOME/.config/fish
mkdir $HOME/.git_template

ln -svf $(pwd)/.config/nvim/* $HOME/.config/nvim/
ln -svf $(pwd)/.gitconfig $HOME/.gitconfig
ln -svf $(pwd)/.gitignore_global ~/.gitignore_global
ln -svf $(pwd)/.gitconfig ~/.gitconfig
ln -svf $(pwd)/.git_template/* ~/.git_template/

rm -f $HOME/.zshrc

### Install vim-plug
sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs \
       https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'

### Install NeoVim plugins
nvim --headless +PlugInstall +qa

# Set default shell
ln -svf $PWD/.config/fish/* $HOME/.config/fish/
ln -svf $PWD/.config/fish/functions/* $HOME/.config/fish/functions/
ln -svf $PWD/.config/fish/completions/* $HOME/.config/fish/completions/
ln -svf $PWD/.config/fish/conf.d/* $HOME/.config/fish/conf.d/

sudo chsh -s "$(which fish)" "$(whoami)"
